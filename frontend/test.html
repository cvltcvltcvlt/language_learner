<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>–¢–µ—Å—Ç —Å–ª—ñ–≤ ‚Äî Language Learner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <style>
    /* === –ó–∞–≥–∞–ª—å–Ω—ñ —Å—Ç–∏–ª—ñ === */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Roboto', sans-serif;
      height: 100vh;
      background: linear-gradient(270deg, #6a11cb, #2575fc, #6a11cb);
      background-size: 600% 600%;
      animation: gradientMove 15s ease infinite;
      overflow-x: hidden;
      color: white;
      position: relative;
    }

    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .background-image {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: url('https://i.pinimg.com/originals/b1/58/74/b158741d3532cf61bdead1bd9e2e87f7.png') no-repeat center center;
      background-size: cover;
      filter: blur(8px) brightness(0.7);
      z-index: -1;
    }

    .navbar {
      width: 100%;
      display: flex;
      justify-content: center;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 20px;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 10;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .nav-item {
      margin: 0 15px;
      font-weight: bold;
      font-size: 18px;
      color: #ffffff;
      text-decoration: none;
      padding: 10px 20px;
      border: 2px solid transparent;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .nav-item:hover {
      background: #2575fc;
      border-color: #2575fc;
      color: white;
      transform: scale(1.05);
    }

    .content {
      margin-top: 120px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .test-box {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      padding: 40px;
      border-radius: 20px;
      width: 100%;
      max-width: 600px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      color: #333;
      animation: fadeInUp 1s ease forwards;
      text-align: center;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h1 {
      margin-bottom: 20px;
      font-size: 28px;
      color: #333;
    }

    input {
      padding: 12px;
      width: 80%;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      margin-top: 10px;
      margin-bottom: 5px;
      background: rgba(255, 255, 255, 0.9);
    }

    input:focus {
      outline: none;
      box-shadow: 0 0 10px rgba(106, 17, 203, 0.6);
      background: white;
    }

    .btn, .audio-btn, .back-btn {
      margin-top: 20px;
      padding: 12px 25px;
      font-size: 18px;
      font-weight: bold;
      color: #2575fc;
      background: transparent;
      border: 2px solid #2575fc;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn:hover, .audio-btn:hover, .back-btn:hover {
      background: #2575fc;
      color: white;
      transform: scale(1.05);
    }

    .audio-btn {
      margin-top: 10px;
      background: #28a745;
      border-color: #28a745;
      color: white;
    }

    .audio-btn:hover {
      background: #218838;
      border-color: #218838;
    }

    .back-btn {
      background: #6c757d;
      border-color: #6c757d;
      color: white;
    }

    .back-btn:hover {
      background: #5a6268;
      border-color: #5a6268;
    }
  </style>
  <link rel="stylesheet" href="style.css?v=2">
</head>

<body>

  <div class="background-image"></div>

  <div class="navbar">
    <a href="profile.html" class="nav-item">–ü—Ä–æ—Ñ—ñ–ª—å üë§</a>
    <a href="lesson.html" class="nav-item">–£—Ä–æ–∫–∏ üìñ</a>
    <a href="test.html" class="nav-item">–¢–µ—Å—Ç–∏ üìù</a>
    <a href="chat.html" class="nav-item">–ß–∞—Ç ü§ñ</a>
    <a href="#" class="nav-item" onclick="logout()">–í–∏–π—Ç–∏ üö™</a>
  </div>

  <div class="content">
    <div class="test-box" id="test-box">
      <h1>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</h1>
    </div>
  </div>

<script>
    const API_URL = 'http://127.0.0.1:8080'; // –∏–ª–∏ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π
    let currentWord = '';
    let currentWordId = null;

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;

    if (!localStorage.getItem('token')) {
      window.location.href = 'login.html';
    }

    // --- –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–∞ ---
    async function loadTest() {
      console.log('loadTest()');
      try {
        const res = await fetch(`${API_URL}/test/words`);
        const data = await res.json();
        currentWord = data.words.word;
        currentWordId = data.words.id;

        document.getElementById('test-box').innerHTML = `
          <h1>–ü–µ—Ä–µ–∫–ª–∞–¥–∏ —Å–ª–æ–≤–æ</h1>
          <p style="font-weight:bold; font-size:22px;">${currentWord}</p>
          <input id="word-translation" placeholder="–¢–≤—ñ–π –ø–µ—Ä–µ–∫–ª–∞–¥">
          <button class="audio-btn" onclick="playAudio()">üîä –í—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏</button><br>
          <button class="btn" onclick="submitTest()">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏</button>
          <button class="btn" id="record-btn" onclick="toggleRecording()">üé§ –û—Ü—ñ–Ω–∏—Ç–∏ –≤–∏–º–æ–≤—É</button>
          <button class="back-btn" onclick="backDashboard()">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
        `;
      } catch (err) {
        console.error('Error in loadTest:', err);
        alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ç–µ—Å—Ç.');
      }
    }

    // --- –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ ---
async function playAudio() {
  try {
    // 1) –ó–∞–ø—Ä–æ—Å –∫–ª—é—á–∞ (–∏–ª–∏ s3_key) –æ—Ç –≤–∞—à–µ–≥–æ –±—ç–∫–∞
    const res1 = await fetch(`${API_URL}/lessons/generate_audio`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ word: currentWord, word_id: currentWordId })
    });
    const data = await res1.json();

    // –¥–æ–ø—É—Å—Ç–∏–º, —ç–Ω–¥–ø–æ–∏–Ω—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç { s3_key: "1122...fc74.wav" }
    const key = data.s3_key;
    if (!key) throw new Error('No s3_key in response');

    // 2) –§–æ—Ä–º–∏—Ä—É–µ–º URL –Ω–∞ –ø—Ä–æ–∫—Å–∏ (8080)
    const url = `${API_URL}/audio-files/${encodeURIComponent(key)}`;

    // 3) –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ Audio
    const audio = new Audio(url);
    await audio.play();

  } catch (err) {
    console.error('Error in playAudio:', err);
    alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏ –∞—É–¥—ñ–æ.');
  }
}

    // --- –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ ---
    async function submitTest() {
      console.log('submitTest()');
      const translation = document.getElementById('word-translation').value.trim();
      try {
        const res = await fetch(`${API_URL}/test/check`, {
          method: 'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            user_id: localStorage.getItem('userId'),
            answers: [{ word_id: currentWordId, translation }]
          })
        });
        const result = await res.json();
        alert(`–ü—Ä–∞–≤–∏–ª—å–Ω–∏—Ö: ${result.correct} / –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏—Ö: ${result.incorrect}`);
        backDashboard();
      } catch (err) {
        console.error('Error in submitTest:', err);
        alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ.');
      }
    }

    function backDashboard() {
      window.location.href = 'dashboard.html';
    }
    function logout() {
      localStorage.clear();
      window.location.href = 'login.html';
    }

    // --- –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è getUserMedia —Å fallback ---
    function getUserMediaCompat(constraints) {
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        return navigator.mediaDevices.getUserMedia(constraints);
      }
      const legacy = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
      if (!legacy) {
        return Promise.reject(new Error('getUserMedia –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'));
      }
      return new Promise((resolve, reject) => {
        legacy.call(navigator, constraints, resolve, reject);
      });
    }

    // --- Callback –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–ø–∏—Å–∏ ---
    async function onRecordingStop() {
      console.log('onRecordingStop()');
      const blob = new Blob(audioChunks, { type: 'audio/webm' });
      const file = new File([blob], 'pronunciation.webm', { type: blob.type });
      const form = new FormData();
      form.append('user_id', localStorage.getItem('userId'));
      form.append('word_id', currentWordId);
      form.append('audio', file);

      try {
        const res = await fetch(`${API_URL}/test/check`, {
          method: 'POST',
          body: form
        });
        const result = await res.json();
        if (result.average_confidence != null) {
          alert(`–û—Ü—ñ–Ω–∫–∞ –≤–∏–º–æ–≤–∏: ${(result.average_confidence * 100).toFixed(1)}%`);
        } else {
          alert('–í–∏–º–æ–≤–∞ –Ω–µ –±—É–ª–∞ –æ—Ü—ñ–Ω–æ–≤–∞–Ω–∞.');
        }
      } catch (err) {
        console.error('Error sending pronunciation:', err);
        alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ü—ñ–Ω—Ü—ñ –≤–∏–º–æ–≤–∏.');
      }
    }

    // --- –ó–∞–ø—É—Å–∫/–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏ ---
    async function toggleRecording() {
      console.log('toggleRecording(), isRecording=', isRecording);
      const btn = document.getElementById('record-btn');

      if (!isRecording) {
        try {
          const stream = await getUserMediaCompat({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];
          mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
          mediaRecorder.onstop = onRecordingStop;
          mediaRecorder.start();
          btn.textContent = '‚èπÔ∏è –ó—É–ø–∏–Ω–∏—Ç–∏ –∑–∞–ø–∏—Å';
          isRecording = true;
          console.log('Recording started');
        } catch (err) {
          console.error('Error accessing mic:', err);
          alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞.');
        }
      } else {
        if (mediaRecorder) {
          mediaRecorder.stop();
          btn.textContent = 'üé§ –û—Ü—ñ–Ω–∏—Ç–∏ –≤–∏–º–æ–≤—É';
          isRecording = false;
          console.log('Recording stopped');
        }
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = loadTest;
  </script>
</body>
</html>
